name: Run Mabl Tests from CSV File

on:
  workflow_dispatch:

jobs:
  get-test-ids:
    runs-on: ubuntu-latest
    outputs:
      test_ids: ${{ steps.get_ids.outputs.test_ids }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Read Test IDs from CSV
        id: get_ids
        run: |
          # Read the CSV file, skipping the header line if it exists.
          # We'll use 'awk' to process each line and 'jq' to format it as a JSON array.
          TEST_IDS=$(awk 'NR > 1' mabl_test_ids.csv | jq -R . | jq -s . | tr -d '\n')
          echo "test_ids=$TEST_IDS" >> $GITHUB_OUTPUT

  mabl-local:
    runs-on: ubuntu-latest
    needs: get-test-ids
    strategy:
      matrix:
        test_id: ${{ fromJSON(needs.get-test-ids.outputs.test_ids) }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Mabl CLI
        run: npm install -g @mablhq/mabl-cli

      - name: Run Test Locally
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb
          
          echo "Running Test ID: ${{ matrix.test_id }}"
          mabl auth activate-key ${{ secrets.MABL_API_KEY }}
          
          xvfb-run mabl tests run --id ${{ matrix.test_id }} --environment-id RH4FfeHgfnxiHFJyKkPsmQ-e